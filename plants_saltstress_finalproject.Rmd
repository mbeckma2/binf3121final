---
title: "Mannitol transgene and salt stress - in plants."
author: "Jennifer Daly, Micaela Beckman"
date: "April 24, 2017"
output: html_document
---

```{r, message=FALSE, warning=F}
#Required libraries
library(affy)
library(limma)
library(RSQLite)
#Import data from sources
pd = read.AnnotatedDataFrame("samples.txt",header=TRUE,sep=",",row.names=1) 
mydata = ReadAffy(filenames=pd$filename,phenoData=pd,verbose=TRUE)
sampleNames(mydata)=row.names(pData(pd))
#Call functions to organize data
eset = rma(mydata)
expression_data = exprs(eset)
```
COL.U1 has multiple blobs on it's image check.

Histogram is not normal but we will normalize the data using eset.

```{r}
TS = paste(pd$genotype,pd$treatment,sep=".")
TS = factor(TS, levels= c("M6PR.U","M6PR.T","COL.U","COL.T"))
```

Create a design matrix:
```{r}
exp_design = model.matrix(~0 + TS)
colnames(exp_design) = levels(TS)
exp_design
```

```{r}
fit=lmFit(eset,exp_design)
```

Functions for creating a bar graph:
```{r}
cont.matrix= makeContrasts(
    M6PR.TvU = M6PR.U - M6PR.T,
    COL.UvT = COL.U - COL.T,
    M6PRvCOL.T = M6PR.T - COL.T,
    M6PRvCOL.U = M6PR.U - COL.U,
    levels = exp_design)
fit2 = contrasts.fit(fit,cont.matrix)
fit2 = eBayes(fit2)
```

Create a bar graph:
```{r}
# lfc =1 for 2-fold changes
result = decideTests(fit2, p.value=0.05, lfc=1)

colnames = c("M6PR.TvU",	"COL.UvT",	"M6PRvCOL.T",	"M6PRvCOL.U")
rownames = c("upregulated", "downregulated")
upregulated = c(sum(result[,1]>0), sum(result[,2]>0), sum(result[,3]>0), sum(result[,4]>0))
downregulated = c(sum(result[,1]<0), sum(result[,2]<0), sum(result[,3]<0), sum(result[,4]<0))

resultsMatrix = matrix(c(upregulated, downregulated), nrow=2, dimnames=list(rownames, colnames))
barplot(as.matrix(resultsMatrix), legend = rownames, beside=TRUE)
```

Bar graph key:
(A) Pathways mainly affected by salt stress; COL.UvT
(B) pathways mainly activated by the M6PR transgene; M6PRvCOL.U
(C) pathways affected by both salt stress and the M6PR transgene. M6PRvCOL.T
(D) Pathways affected by the presence of the M6PR gene M6PR.TvU

Functions for creating a venn diagram:
```{r}
cont.matrix2= makeContrasts(
    M6PR.TvU = M6PR.U - M6PR.T,
    COL.UvT = COL.U - COL.T, 
    Diff = (M6PR.U - M6PR.T) - (COL.U - COL.T),
    levels = exp_design)
fit3 = contrasts.fit(fit,cont.matrix2)
fit3 = eBayes(fit3)
```

Create a Venn Diagram:
```{r}
# lfc =1 for 2-fold changes
result2 = decideTests(fit3, p.value=0.05, lfc=1)
vennDiagram(result2)
vennCounts(result2)
```

Venn Diagram key:
(A) Pathways mainly affected by salt stress; COL.UvT
(B) Pathways mainly activated by the M6PR transgene; M6PRvCOL.U
(C) Pathways affected by both salt stress and the M6PR transgene. diff

Retreve annotations:
```{r}
f="ftp://ftp.arabidopsis.org/Microarrays/Affymetrix/affy_ATH1_array_elements-2010-12-20.txt" 
annots = read.delim(f, na.strings = "", fill=TRUE, header=T, sep="\t") 
annots=annots[,c(1,5,6)] #Save selected (columns 1,5,6) info in annots table
```

Select top genes from each comparison:
#Select the most sigificantly different genes. 
```{r}
N=dim(eset)[1] 
top.M6PR.TvU = topTable(fit3,coef=1,number=N,p.value=0.05) 
top.COL.UvT = topTable(fit3,coef=2,number=N,p.value=0.05) 
top.Diff = topTable(fit3,coef=3,number=N,p.value=0.05) 
```

Merge annotations with top lists:
#So that we have annotation names instead of probe set numbers. 
```{r}
row.names(annots)=annots$array_element_name 
top.COL.UvT.merged=merge(annots,top.COL.UvT,by="row.names") #(A) Pathways mainly affected by salt stress
top.M6PR.TvU.merged=merge(annots,top.M6PR.TvU,by="row.names") #(B) Pathways mainly activated by the M6PR transgene
top.Diff.merged=merge(annots,top.Diff,by="row.names") #(C) Pathways affected by both salt stress and the M6PR transgene
```

Count differently expressed genes:
#because there may be multiple probe sets to one gene (annotation)
```{r}
genes.M6PR.TvU = unique(top.M6PR.TvU.merged$locus)
genes.COL.UvT = unique(top.COL.UvT.merged$locus)
genes.Diff = unique(top.Diff.merged$locus)
intersection = intersect(genes.COL.UvT,genes.M6PR.TvU)
```

